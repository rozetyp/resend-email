<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Resend BYOK Mailer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      margin: 0;
      padding: 2rem;
    }
    .card {
      max-width: 720px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    label { display:block; font-size:0.9rem; margin-bottom:0.25rem; font-weight:600; }
    input, textarea { width:100%; box-sizing:border-box; padding:0.5rem 0.75rem; border-radius:8px; border:1px solid #d0d0d5; margin-bottom:0.75rem; font:inherit; }
    textarea { min-height:180px; resize:vertical; }
    button { padding:0.6rem 1.4rem; border-radius:999px; border:none; font-weight:600; cursor:pointer; background:#2563eb; color:white; }
    .title { font-size:1.4rem; font-weight:700; margin-bottom:1rem; }
    .subtitle { font-size:0.9rem; color:#555; margin-bottom:1.25rem; }
    .alert { padding:0.75rem 1rem; border-radius:8px; margin-bottom:1rem; font-size:0.9rem; }
    .alert-error { background:#fee2e2; color:#b91c1c; border:1px solid #fecaca; }
    .alert-success { background:#dcfce7; color:#166534; border:1px solid #bbf7d0; }
    .meta { font-size:0.8rem; color:#777; margin-bottom:0.75rem; }
  </style>
</head>
<body>
  <div class="card">
    <div class="title">Resend BYOK Mailer</div>
    <div class="subtitle">Send emails from your Resend account using your own domain, via a simple UI.</div>

    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    {% if result and not error %}
    <div class="alert alert-success">Email sent! ID: {{ result.get('id') if result else '' }}</div>
    {% endif %}

    <div class="meta">Using server-side RESEND_API_KEY; make sure your domain is verified in Resend.</div>

    <form method="post" action="/send">
      <label for="from_email">From</label>
      {% if domains %}
      <div style="margin-bottom:0.75rem;">
        <div style="margin-bottom:0.5rem;font-weight:700;">Verified domains</div>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.5rem;">
          {% for d in domains %}
          <button type="button" class="domain-chip" data-domain="{{ d }}" style="background:#eef2ff;border:1px solid #c7d2fe;padding:.35rem .6rem;border-radius:999px;cursor:pointer;">{{ d }}</button>
          {% endfor %}
        </div>
        <div style="display:flex;gap:.5rem;align-items:center;">
          <select id="domain_select" style="flex:0 0 320px;" aria-label="Select domain">
            <option value="">Choose a verified domain...</option>
            {% for d in domains %}
            {% set name = default_from.split('<')[0].strip() if default_from else '' %}
            {% if name %}
            <option value="{{ name }} <no-reply@{{ d }}>">{{ name }} &lt;no-reply@{{ d }}&gt;</option>
            {% else %}
            <option value="no-reply@{{ d }}">no-reply@{{ d }}</option>
            {% endif %}
            {% endfor %}
          </select>
          <label style="font-size:.9rem;color:#444;display:flex;align-items:center;gap:.4rem;"><input id="lock_from" type="checkbox"/> Lock From to selected domain</label>
        </div>
      </div>
      {% else %}
      <div style="margin-bottom:.5rem;color:#92400e;background:#fff7ed;padding:.6rem;border-radius:8px;border:1px solid #ffd8a8;">
        <strong>No verified domains found.</strong>
        {% if domains_error %}
        <div style="font-size:.9rem;margin-top:.25rem;color:#92400e;">Reason: {{ domains_error }}</div>
        {% else %}
        <div style="font-size:.9rem;margin-top:.25rem;color:#92400e;">The app couldn't fetch verified domains from Resend. You can still send email, but server-side validation won't run.</div>
        {% endif %}
      </div>
      {% endif %}

      <input id="from_email" name="from_email" type="text" value="{{ default_from or '' }}" placeholder="Your Name &lt;no-reply@yourdomain.com&gt;" required />

      <label for="to_email">To</label>
      <input id="to_email" name="to_email" type="email" value="{{ last_to or '' }}" placeholder="recipient@example.com" required />

      <label for="subject">Subject</label>
      <input id="subject" name="subject" type="text" value="{{ last_subject or '' }}" placeholder="Subject line" required />

      <label for="body">Body (HTML allowed)</label>

      <div style="display:flex;gap:.5rem;margin-bottom:.5rem;align-items:center;">
        <div>
          <button type="button" data-cmd="bold">Bold</button>
          <button type="button" data-cmd="italic">Italic</button>
          <button type="button" data-cmd="link">Link</button>
          <button type="button" data-cmd="p">Paragraph</button>
          <button type="button" data-cmd="clear">Clear</button>
          <button type="button" id="preview_btn">Preview</button>
        </div>
      </div>

      <textarea id="body" name="body" placeholder="<p>Hello from Resend BYOK UI!</p>" required>{{ last_body or '' }}</textarea>

      <div id="preview" style="display:none;border:1px solid #e5e7eb;padding:1rem;border-radius:8px;margin-top:.5rem;background:#fff;">
        <div style="font-weight:700;margin-bottom:.5rem;">Preview</div>
        <div id="preview_content"></div>
      </div>

      <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">
        <button type="button" id="send_preview_btn" style="background:#6b7280;padding:.5rem .9rem;border-radius:8px;border:none;color:white;">Preview email</button>
        <button type="submit">Send email</button>
      </div>
    </form>
    <script>
      (function(){
        const sel = document.getElementById('domain_select');
        const from = document.getElementById('from_email');
        const lock = document.getElementById('lock_from');
        const chips = document.querySelectorAll('.domain-chip');
        const body = document.getElementById('body');
        const previewBtn = document.getElementById('preview_btn');
        const preview = document.getElementById('preview');
        const previewContent = document.getElementById('preview_content');

        function setFrom(val){
          if (!from) return;
          from.value = val;
        }

        // Pre-select a domain based on DEFAULT_FROM if present, otherwise pick first
        function initDomain(){
          try{
            const defaultFrom = '{{ default_from or "" }}';
            let defaultDomain = '';
            if(defaultFrom){
              const m = defaultFrom.match(/@([^>\s]+)\b/);
              if(m) defaultDomain = m[1];
            }
            if(sel && sel.options.length>1){
              let picked = -1;
              for(let i=1;i<sel.options.length;i++){
                const opt = sel.options[i];
                if(defaultDomain && opt.value.includes('@'+defaultDomain)){
                  picked = i; break;
                }
              }
              if(picked===-1) picked = 1; // first verified domain
              sel.selectedIndex = picked;
              // populate From if empty
              if(!from.value) from.value = sel.options[picked].value;
            }
          }catch(e){/* ignore */}
        }

        if(sel && from){
          sel.addEventListener('change', function(){
            if(!this.value) return;
            if(lock && lock.checked){
              setFrom(this.value);
            }
          });
        }

        // clicking chips selects domain and populates From
        chips.forEach(c => c.addEventListener('click', function(){
          const d = this.dataset.domain;
          if(!d) return;
          // build value
          const name = (('' + ('{{ default_from or "" }}')).split('<')[0] || '').trim();
          const val = name ? (name + ' <no-reply@' + d + '>') : ('no-reply@' + d);
          if(sel){
            // find matching option
            for(let i=0;i<sel.options.length;i++){
              if(sel.options[i].value.includes('@'+d)){
                sel.selectedIndex = i; break;
              }
            }
          }
          if(lock && lock.checked){
            setFrom(val);
          } else {
            // update from input but allow editing
            setFrom(val);
          }
        }));

        // toolbar actions for body textarea
        function wrapSelection(before, after){
          const ta = body;
          const start = ta.selectionStart || 0;
          const end = ta.selectionEnd || 0;
          const selected = ta.value.substring(start,end);
          const newVal = ta.value.substring(0,start) + before + selected + after + ta.value.substring(end);
          ta.value = newVal;
          ta.focus();
          ta.selectionStart = start + before.length;
          ta.selectionEnd = start + before.length + selected.length;
        }

        document.querySelectorAll('[data-cmd]').forEach(btn => {
          btn.addEventListener('click', function(){
            const cmd = this.getAttribute('data-cmd');
            if(!body) return;
            if(cmd==='bold') wrapSelection('<strong>','</strong>');
            if(cmd==='italic') wrapSelection('<em>','</em>');
            if(cmd==='p') wrapSelection('<p>','</p>');
            if(cmd==='clear') { body.value = ''; preview.style.display='none'; }
            if(cmd==='link'){
              const url = prompt('Enter URL (https://...)');
              if(url) wrapSelection('<a href="'+url+'">','</a>');
            }
          });
        });

        previewBtn && previewBtn.addEventListener('click', function(){
          if(!preview) return;
          if(preview.style.display==='none'){
              // include header preview (From/To/Subject) + body
              const subjectEl = document.getElementById('subject');
              const toEl = document.getElementById('to_email');
              const fromEl = document.getElementById('from_email');
              const subj = subjectEl ? subjectEl.value : '';
              const to = toEl ? toEl.value : '';
              const fr = fromEl ? fromEl.value : '';
              let hdr = '<div style="margin-bottom:.75rem;padding:.5rem;border-radius:6px;background:#f8fafc;border:1px solid #e6eef8;">';
              hdr += '<div style="font-weight:700;margin-bottom:.25rem;">' + (subj||'(no subject)') + '</div>';
              hdr += '<div style="font-size:.9rem;color:#333">From: ' + (fr||'(no from)') + '</div>';
              hdr += '<div style="font-size:.9rem;color:#333">To: ' + (to||'(no to)') + '</div>';
              hdr += '</div>';
              previewContent.innerHTML = hdr + (body.value || '<i>(empty)</i>');
            preview.style.display = 'block';
            this.textContent = 'Hide preview';
          } else {
            preview.style.display = 'none';
            this.textContent = 'Preview';
          }
        });

        // preview from the Send area
        const sendPreviewBtn = document.getElementById('send_preview_btn');
        sendPreviewBtn && sendPreviewBtn.addEventListener('click', function(e){
          e.preventDefault();
          if(!preview) return;
          // reuse same logic as toolbar preview
          if(preview.style.display==='none'){
            const subjectEl = document.getElementById('subject');
            const toEl = document.getElementById('to_email');
            const fromEl = document.getElementById('from_email');
            const subj = subjectEl ? subjectEl.value : '';
            const to = toEl ? toEl.value : '';
            const fr = fromEl ? fromEl.value : '';
            let hdr = '<div style="margin-bottom:.75rem;padding:.5rem;border-radius:6px;background:#f8fafc;border:1px solid #e6eef8;">';
            hdr += '<div style="font-weight:700;margin-bottom:.25rem;">' + (subj||'(no subject)') + '</div>';
            hdr += '<div style="font-size:.9rem;color:#333">From: ' + (fr||'(no from)') + '</div>';
            hdr += '<div style="font-size:.9rem;color:#333">To: ' + (to||'(no to)') + '</div>';
            hdr += '</div>';
            previewContent.innerHTML = hdr + (body.value || '<i>(empty)</i>');
            preview.style.display = 'block';
            preview.scrollIntoView({behavior:'smooth', block:'center'});
            // update toolbar preview button label if present
            if(previewBtn) previewBtn.textContent = 'Hide preview';
          } else {
            preview.style.display = 'none';
            if(previewBtn) previewBtn.textContent = 'Preview';
          }
        });

        initDomain();
      })();
    </script>
  </div>
</body>
</html>
