<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Resend Pad – Free Resend Email Editor & GUI | Test & Send Emails Without Code</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Free web-based GUI for Resend API. Test and send transactional emails, HTML email editor, load verified domains, no code required. BYOK, no storage, no tracking. Perfect for testing and development." />
  <meta name="keywords" content="Resend email editor, Resend GUI, Resend web interface, send email without code, send email from custom domain, send email from your domain, professional email sender, branded email sending, free email tool, BYOK email, Resend API UI, no-code email, email testing tool, test Resend API, Resend playground, transactional email sender, email API tester, HTML email composer, rich text email editor, browser email sender, verify email sending, custom domain email, domain email sender, SendGrid alternative, Mailgun alternative" />
  <meta name="author" content="Resend Pad" />
  <meta name="robots" content="index, follow" />
  <meta property="og:title" content="Resend Pad – Send Emails Without Code" />
  <meta property="og:description" content="Free email editor for Resend. Paste key, load domains, compose, send. No storage." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://resendpad.up.railway.app" />
  <meta property="og:image" content="https://resendpad.up.railway.app/og-image.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://resendpad.up.railway.app/og-image.png" />
  <meta name="twitter:title" content="Resend Pad – Send Emails Without Code" />
  <meta name="twitter:description" content="Free email editor for Resend. No code, no storage, no tracking." />
  <meta name="google-site-verification" content="RqTkgBU8WKBxrFgDaU4OTdzd2EdYXZ_YMjoOkhOGVdU" />
  <link rel="canonical" href="https://resendpad.up.railway.app" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Quill Rich Text Editor CSS -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Resend Pad",
    "description": "Free email editor for Resend. Send emails without code.",
    "url": "https://resendpad.up.railway.app",
    "applicationCategory": "ProductionApplication",
    "operatingSystem": "Web",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "creator": {
      "@type": "Organization",
      "name": "Resend Pad",
      "url": "https://github.com/rozetyp/resend-email"
    }
  }
  </script>
  
  <style>
    /* Custom styles for Quill editor */
    .ql-editor {
      min-height: 250px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    
    .ql-toolbar.ql-snow {
      border-top: 1px solid #d1d5db;
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      border-bottom: 0;
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
      background: #f9fafb;
    }
    
    .ql-container.ql-snow {
      border-bottom: 1px solid #d1d5db;
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      border-top: 0;
      border-bottom-left-radius: 0.5rem;
      border-bottom-right-radius: 0.5rem;
    }
  </style>
</head>

<body class="bg-gray-100">
  <!-- ============ MAIN APP CONTAINER ============ -->
  <div class="min-h-screen w-full p-4 sm:p-8 flex items-center justify-center">
    
    <div class="w-full max-w-3xl bg-white text-gray-900 rounded-xl shadow-2xl p-6 sm:p-8 mt-16">
      
      <h1 class="text-3xl font-bold text-center text-gray-900 mb-2">
        Resend Pad
      </h1>
      
      <p class="text-center text-sm text-gray-600 mb-6">
        Send emails with Resend using your own API key. No server relay. Built for developers.
      </p>
      
      <div class="form-container">
        <form id="send_form">
          
          <!-- API KEY INPUT -->
          <div class="mb-5">
            <label for="api_key" class="block mb-2 text-sm font-medium text-gray-900">Your Resend API Key</label>
            <input 
              id="api_key" 
              name="api_key" 
              type="password" 
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
              placeholder="re_xxxxxxxxxxxxxxxxxxxxx" 
              style="font-family: 'Courier New', monospace;"
              required
            />
            <p class="mt-1 text-xs text-gray-500">Stays in your browser. Never stored.</p>
            <div class="p-3 mt-3 text-xs text-blue-800 rounded-lg bg-blue-50" role="alert">
              Tip: Need "Full Access" key to list domains. <a href="https://resend.com/api-keys" target="_blank" class="underline hover:no-underline">Get one →</a>
            </div>
          </div>

          <!-- FROM NAME -->
          <div class="mb-5">
            <label for="from_name" class="block mb-2 text-sm font-medium text-gray-900">From Name <span class="text-gray-400 font-normal">(optional)</span></label>
            <input 
              id="from_name" 
              name="from_name" 
              type="text" 
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
              placeholder="John Smith"
            />
            <p class="mt-1 text-xs text-gray-500">Display name shown to recipients.</p>
          </div>

          <!-- FROM EMAIL -->
          <div class="mb-5">
            <label for="from_email" class="block mb-2 text-sm font-medium text-gray-900">From Email</label>
            <div class="flex flex-col sm:flex-row gap-2">
              <input 
                id="from_email" 
                name="from_email" 
                type="email" 
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                placeholder="no-reply@yourdomain.com" 
                required 
              />
              <button type="button" id="fetch_domains_btn" class="flex-shrink-0 text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-4 py-2.5">
                Load Domains
              </button>
            </div>
            <p class="mt-1 text-xs text-gray-500">Must be verified in your Resend account.</p>
            <div id="domains_list" class="hidden mt-2 p-3 bg-blue-50 rounded-lg text-sm text-blue-800"></div>
          </div>

          <!-- TO EMAIL -->
          <div class="mb-5">
            <label for="to_email" class="block mb-2 text-sm font-medium text-gray-900">To Email</label>
            <input 
              id="to_email" 
              name="to_email" 
              type="email" 
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
              placeholder="recipient@example.com" 
              required 
            />
            <p class="mt-1 text-xs text-gray-500">Single recipient email address.</p>
          </div>

          <!-- CC -->
          <div class="mb-5">
            <label for="cc_email" class="block mb-2 text-sm font-medium text-gray-900">CC <span class="text-gray-400 font-normal">(optional)</span></label>
            <input 
              id="cc_email" 
              name="cc_email" 
              type="email" 
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
              placeholder="cc@example.com"
            />
          </div>

          <!-- BCC -->
          <div class="mb-5">
            <label for="bcc_email" class="block mb-2 text-sm font-medium text-gray-900">BCC <span class="text-gray-400 font-normal">(optional)</span></label>
            <input 
              id="bcc_email" 
              name="bcc_email" 
              type="email" 
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
              placeholder="bcc@example.com"
            />
          </div>

          <!-- SUBJECT & THREADING -->
          <div class="mb-5">
            <label for="subject" class="block mb-2 text-sm font-medium text-gray-900">Subject</label>
            <div class="flex flex-col sm:flex-row gap-2">
                <input 
                  id="subject" 
                  name="subject" 
                  type="text" 
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 transition-shadow"
                  placeholder="Your subject line" 
                  required 
                />
                <button type="button" id="toggle_reply_btn" class="flex-shrink-0 text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-4 py-2.5 whitespace-nowrap">
                    <span id="toggle_reply_text">Connect Thread</span>
                </button>
            </div>

            <!-- HIDDEN THREADING SECTION -->
            <div id="reply_section" class="hidden mt-3 transition-all duration-300 ease-in-out">
              <!-- STATE 1: INPUT AREA -->
              <div id="reply_input_area">
                  <div class="relative">
                    <textarea 
                        id="raw_headers" 
                        rows="3"
                        class="bg-white border border-gray-200 text-gray-600 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 font-mono shadow-sm hover:border-gray-300 transition-colors resize-y"
                        placeholder="Paste original email headers here..."
                    ></textarea>
                    <div class="absolute bottom-2 right-2 text-[10px] text-gray-300 pointer-events-none font-medium uppercase tracking-wider">
                        Auto-detect
                    </div>
                  </div>
                  <p class="mt-1 text-xs text-gray-500">
                    Paste from Gmail's <strong>Show original</strong> to auto-fill context.
                  </p>
                  
                  <!-- Error feedback -->
                  <div id="extract_error" class="hidden mt-1 text-xs text-red-600 font-medium pl-1">
                    <span id="extract_error_msg"></span>
                  </div>
              </div>

              <!-- STATE 2: SUCCESS CARD -->
              <div id="thread_summary_card" class="hidden">
                  <div class="flex items-center justify-between p-2 pl-3 bg-gray-50 border border-gray-200 rounded-md">
                      <div class="flex items-center gap-3 overflow-hidden">
                          <div class="flex-shrink-0 text-blue-500">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                              </svg>
                          </div>
                          <div class="min-w-0 flex flex-col">
                              <span class="text-xs font-semibold text-gray-700">Thread Linked: <span id="summary_subject" class="font-normal text-gray-500">...</span></span>
                              <div class="flex items-center gap-1 text-[10px] text-gray-400 font-mono">
                                  <span id="summary_to" class="truncate max-w-[150px]">...</span>
                                  <span class="mx-1 opacity-50">•</span>
                                  <span id="summary_id" class="opacity-75">...</span>
                              </div>
                          </div>
                      </div>
                      <button type="button" id="reset_thread_btn" class="ml-2 p-1 text-gray-400 hover:text-red-500 rounded transition-colors" title="Disconnect">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                          </svg>
                      </button>
                  </div>
              </div>

              <!-- Hidden fields -->
              <input type="hidden" id="in_reply_to">
              <input type="hidden" id="references">
            </div>
          </div>

          <!-- EMAIL BODY (QUILL EDITOR) -->
          <div class="mb-5">
            <label for="quill-editor" class="block mb-2 text-sm font-medium text-gray-900">Email Body</label>
            <div id="quill-editor"></div>
            <input type="hidden" id="body" name="body" value="" />
          </div>

          <!-- JS-controlled ERROR/SUCCESS ALERTS -->
          <div id="message_container">
            <!-- JS will inject success/error messages here -->
          </div>
          
          <!-- Non-blocking JS error message -->
          <div id="error-message" class="hidden p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50" role="alert"></div>

          <!-- ACTION BUTTONS -->
          <div class="flex justify-between">
            <button type="reset" id="reset_btn" class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-5 py-2.5">
              Reset
            </button>
            <button type="submit" id="send_btn" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 focus:outline-none">
              Send Email
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ============ QUILL EDITOR & INTERACTIONS ============ -->
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script>
    // Auto-detect API URL based on environment
    const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3001'
      : `${window.location.protocol}//${window.location.host}`;
    
    document.addEventListener('DOMContentLoaded', function() {
        // ============ QUILL EDITOR ============
        var quill = new Quill('#quill-editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              ['bold', 'italic', 'underline'],
              [{ 'header': [1, 2, false] }],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              ['link'],
              ['code-block'],
              ['clean']
            ]
          }
        });

        // Update hidden input when content changes
        // Also sanitize HTML for email clients (reduce spacing issues)
        quill.on('text-change', function() {
          let html = quill.root.innerHTML;
          // Clean up Quill's HTML for better email rendering
          html = sanitizeForEmail(html);
          document.getElementById('body').value = html;
        });
        
        // Sanitize HTML for email clients
        function sanitizeForEmail(html) {
          // Remove default Quill paragraph spacing by adding inline styles
          html = html.replace(/<p>/g, '<p style="margin: 0 0 10px 0; padding: 0;">');
          html = html.replace(/<h1>/g, '<h1 style="margin: 16px 0 8px 0; padding: 0; font-size: 32px; font-weight: bold;">');
          html = html.replace(/<h2>/g, '<h2 style="margin: 14px 0 7px 0; padding: 0; font-size: 24px; font-weight: bold;">');
          html = html.replace(/<ul>/g, '<ul style="margin: 10px 0; padding-left: 30px;">');
          html = html.replace(/<ol>/g, '<ol style="margin: 10px 0; padding-left: 30px;">');
          html = html.replace(/<li>/g, '<li style="margin: 0 0 5px 0;">');
          html = html.replace(/<pre/g, '<pre style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;"');
          // Remove empty paragraphs that create extra space
          html = html.replace(/<p><br><\/p>/g, '');
          html = html.replace(/<p>\s*<\/p>/g, '');
          return html;
        }

        // ============ DOMAIN FETCHING ============
        const fetchDomainsBtn = document.getElementById('fetch_domains_btn');
        const domainsList = document.getElementById('domains_list');
        const apiKeyInput = document.getElementById('api_key');
        const fromEmailInput = document.getElementById('from_email');

        fetchDomainsBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          const apiKey = apiKeyInput.value.trim();
          
          if (!apiKey) {
            domainsList.textContent = '❌ Please enter your Resend API key first.';
            domainsList.classList.remove('hidden');
            return;
          }

          fetchDomainsBtn.disabled = true;
          fetchDomainsBtn.textContent = 'Loading...';
          domainsList.classList.add('hidden');

          try {
            // Call Resend API to get domains
            const response = await fetch(`${API_URL}/api/domains`, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${apiKey}`
              }
            });

            const data = await response.json();

            if (!response.ok) {
              // Handle different error scenarios
              if (response.status === 401 || response.status === 403) {
                throw new Error(`Unauthorized: Your API key may be "Sending Only" or invalid. Use a "Full Access" key to list domains. Get one at https://resend.com/api-keys`);
              } else if (response.status === 429) {
                throw new Error(`Rate limited: Too many requests. Wait a moment and try again.`);
              } else {
                const errorMsg = data.message || data.error || `API error: ${response.status}`;
                throw new Error(errorMsg);
              }
            }

            const domains = data.data || [];
            
            if (domains.length === 0) {
              domainsList.textContent = '❌ No verified domains found. Add one in your Resend dashboard at https://resend.com/domains';
              domainsList.classList.remove('hidden');
            } else {
              // Create domain selector
              let html = '<strong>Select a verified domain:</strong><div class="mt-2 flex flex-wrap gap-2">';
              domains.forEach(domain => {
                html += `<button type="button" class="domain-btn text-xs font-medium px-2.5 py-1.5 rounded-md bg-white border border-gray-300 hover:bg-gray-100" data-domain="${domain.name}">${domain.name}</button>`;
              });
              html += '</div>';
              domainsList.innerHTML = html;
              domainsList.classList.remove('hidden');

              // Add click handlers to domain buttons
              document.querySelectorAll('.domain-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                  e.preventDefault();
                  const domain = this.dataset.domain;
                  const defaultFrom = fromEmailInput.value.split('@')[0] || 'noreply';
                  fromEmailInput.value = `${defaultFrom}@${domain}`;
                  domainsList.classList.add('hidden');
                });
              });
            }
          } catch (error) {
            domainsList.innerHTML = `<strong>❌ Failed to fetch domains:</strong><div class="mt-1 text-xs">${error.message}</div><div class="mt-2 text-xs text-gray-600">Still having issues? You can manually enter your From email (must be verified in Resend).</div>`;
            domainsList.classList.remove('hidden');
            console.error('Domain fetch error:', error);
          } finally {
            fetchDomainsBtn.disabled = false;
            fetchDomainsBtn.textContent = 'Load Domains';
          }
        });

        // ============ REPLY THREADING HELPER ============
        // Toggle reply section
        document.getElementById('toggle_reply_btn').addEventListener('click', function() {
          const section = document.getElementById('reply_section');
          const text = document.getElementById('toggle_reply_text');
          const isHidden = section.classList.contains('hidden');
          
          if (isHidden) {
            section.classList.remove('hidden');
            text.textContent = 'Cancel';
          } else {
            section.classList.add('hidden');
            text.textContent = 'Connect Thread';
          }
        });

        const rawHeadersInput = document.getElementById('raw_headers');
        const replyInputArea = document.getElementById('reply_input_area');
        const threadSummaryCard = document.getElementById('thread_summary_card');
        const errorEl = document.getElementById('extract_error');
        const errorMsg = document.getElementById('extract_error_msg');

        // Auto-detect headers on paste with debounce
        rawHeadersInput.addEventListener('input', debounce(function(e) {
            const content = this.value;
            // Simple heuristic: does it look like email headers?
            if (content.length > 20 && (content.match(/Message-ID:/i) || (content.match(/From:/i) && content.match(/Subject:/i)))) {
                extractHeaders(e);
            }
        }, 500));

        // Reset Threading Button
        document.getElementById('reset_thread_btn').addEventListener('click', function() {
            // 1. Clear Data (Threading + Visible Fields)
            document.getElementById('in_reply_to').value = '';
            document.getElementById('references').value = '';
            document.getElementById('subject').value = '';
            document.getElementById('to_email').value = '';
            rawHeadersInput.value = '';
            
            // 2. Remove the auto-generated quote from Editor
            if (quill) {
                let html = quill.root.innerHTML;
                // Regex to match the standard quote block we inserted
                // Matches: <p><br></p><p>On ... wrote:</p><blockquote ...>...</blockquote><p><br></p>
                // We make it slightly flexible to catch variations
                const quoteRegex = /<p>On .*? wrote:<\/p><blockquote[^>]*>.*?<\/blockquote>/i;
                const brRegex = /<p><br><\/p>/g;
                
                if (html.match(quoteRegex)) {
                   html = html.replace(quoteRegex, '');
                   // Clean up potential double-spacing left behind
                   html = html.replace(/<p><br><\/p><p><br><\/p>/g, '<p><br></p>'); 
                   quill.root.innerHTML = html;
                }
            }
            
            // 3. Toggle UI State
            threadSummaryCard.classList.add('hidden');
            replyInputArea.classList.remove('hidden');
            errorEl.classList.add('hidden');
            
            // 4. Focus back on headers input
            rawHeadersInput.focus();
        });

        function extractHeaders(e) {
          const rawHeaders = rawHeadersInput.value;
          
          // Hide previous error
          errorEl.classList.add('hidden');
          
          if (!rawHeaders.trim()) return;
          
          // SAFETY: Prevent ReDoS or freezing on massive pastes
          if (rawHeaders.length > 50000) {
              errorMsg.textContent = 'Input too large. Please paste only the headers.';
              errorEl.classList.remove('hidden');
              return;
          }
          
          try {
            // 1. Try strict parsing first
            let headers = parseEmailHeaders(rawHeaders);
            
            // 2. Fallback to smart fuzzy search if key fields are missing
            if (!headers['message-id']) {
                headers = smartParseHeaders(rawHeaders, headers);
            }
            
            // Extract values
            const messageId = headers['message-id'];
            const references = headers['references'];
            const from = headers['from'] || headers['reply-to'];
            const subject = headers['subject'];
            const date = headers['date'];
            
            // Validate minimum required field
            if (!messageId) {
               // Silent fail on auto-type, strict on manual? 
               // Since we only have auto-type now, we only throw if it looked like a real attempt
               if(rawHeaders.length > 100) throw new Error('Could not find Message-ID. Paste full headers.');
               return;
            }
            
            // Set threading headers (hidden fields)
            document.getElementById('in_reply_to').value = messageId;
            document.getElementById('references').value = references ? `${references} ${messageId}` : messageId;
            
            // Auto-fill To field
            let toEmail = '';
            let fromName = '';
            if (from) {
              toEmail = extractEmailAddress(from);
              fromName = extractName(from);
              if (toEmail) document.getElementById('to_email').value = toEmail;
            }
            
            // Auto-fill Subject with Re: prefix
            let reSubject = '';
            if (subject) {
              reSubject = subject.toLowerCase().startsWith('re:') ? subject : `Re: ${subject}`;
              document.getElementById('subject').value = reSubject;
            }

            // "Reply Quote" Generator
            if (date && from && quill) {
                const cleanDate = formatDateForQuote(date);
                const quoteHeader = `<p><br></p><p>On ${cleanDate}, ${fromName || toEmail} wrote:</p><blockquote style="border-left: 2px solid #ccc; padding-left: 10px; margin-left: 5px; color: #666;">...</blockquote><p><br></p>`;
                
                if (quill.getText().trim().length === 0) {
                     quill.clipboard.dangerouslyPasteHTML(0, quoteHeader);
                }
            }
            
            // UPDATE UI STATE: Success
            document.getElementById('summary_subject').textContent = reSubject || '(No Subject)';
            document.getElementById('summary_to').textContent = toEmail || '(Unknown)';
            document.getElementById('summary_id').textContent = `ID: ${messageId.substring(0, 25)}...`;
            
            // Switch Views
            replyInputArea.classList.add('hidden');
            threadSummaryCard.classList.remove('hidden');
            
            // Focus on editor
            setTimeout(() => { if (quill) quill.focus(); }, 300);
            
          } catch (error) {
             errorMsg.textContent = error.message;
             errorEl.classList.remove('hidden');
          }
        }

        // Helper: Debounce function
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // Smart Regex Parser (Fallback)
        function smartParseHeaders(raw, existingHeaders) {
            const headers = { ...existingHeaders };
            // Improved regex to handle both multi-line and single-line (messy) pastes
            // Uses lookahead to stop at the next common header or end of string
            const commonHeaders = 'Message-ID:|Subject:|From:|Date:|To:|References:';
            const patterns = {
                'message-id': /Message-ID:\s*(<[^>]+>)/i,
                'subject': new RegExp(`Subject:\\s*(.*?)(?=\\s*(?:${commonHeaders}|$))`, 'i'),
                'from': new RegExp(`From:\\s*(.*?)(?=\\s*(?:${commonHeaders}|$))`, 'i'),
                'date': new RegExp(`Date:\\s*(.*?)(?=\\s*(?:${commonHeaders}|$))`, 'i'),
                'references': new RegExp(`References:\\s*(.*?)(?=\\s*(?:${commonHeaders}|$))`, 'i')
            };

            for (const [key, regex] of Object.entries(patterns)) {
                if (!headers[key]) {
                    const match = raw.match(regex);
                    if (match && match[1]) {
                        headers[key] = match[1].trim();
                    }
                }
            }
            return headers;
        }
        
        // Parse email headers (Strict)
        function parseEmailHeaders(raw) {
          const headers = {};
          const lines = raw.split('\n');
          let currentHeader = '';
          let currentValue = '';
          
          for (let line of lines) {
            // Check if line starts with whitespace (continuation of previous header)
            if (line.match(/^\s/) && currentHeader) {
              currentValue += ' ' + line.trim();
            } else {
              // Save previous header if exists
              if (currentHeader) {
                headers[currentHeader.toLowerCase()] = currentValue.trim();
              }
              
              // Parse new header
              const match = line.match(/^([^:]+):\s*(.*)$/);
              if (match) {
                currentHeader = match[1];
                currentValue = match[2];
              } else {
                currentHeader = '';
                currentValue = '';
              }
            }
          }
          
          // Save last header
          if (currentHeader) {
            headers[currentHeader.toLowerCase()] = currentValue.trim();
          }
          
          return headers;
        }
        
        // Extract email address from "Name <email@example.com>" format
        function extractEmailAddress(str) {
          const match = str.match(/<([^>]+)>/);
          if (match) return match[1];
          // If no brackets, check if it's just an email
          if (str.includes('@')) return str.trim();
          return '';
        }

        // Extract name from "Name <email@example.com>"
        function extractName(str) {
            const match = str.match(/^"?([^"<]+)"?\s*</);
            return match ? match[1].trim() : str.split('@')[0];
        }

        // Format date for quote line
        function formatDateForQuote(dateStr) {
            try {
                const d = new Date(dateStr);
                // format: Mon, Jan 2, 2023 at 3:04 PM
                return d.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
            } catch(e) { return dateStr; }
        }

        // ============ FORM SUBMISSION ============
        const form = document.getElementById('send_form');
        const errorDiv = document.getElementById('error-message');
        const messageContainer = document.getElementById('message_container');
        const sendBtn = document.getElementById('send_btn');
        const resetBtn = document.getElementById('reset_btn');

        // Reset button handler (clears Quill editor too)
        resetBtn.addEventListener('click', function(e) {
          e.preventDefault();
          form.reset();
          if (quill) {
            quill.setContents([]);
            // Immediately focus the editor and prevent button from staying focused
            quill.focus();
          }
          document.getElementById('body').value = '';
          errorDiv.classList.add('hidden');
          messageContainer.innerHTML = '';
          // Remove focus from the reset button
          this.blur();
        });

        if(form){
          form.addEventListener('submit', async function(e){
            e.preventDefault(); // Stop default form submission
            console.log('Form submitted');
            
            // 0. Clear previous messages
            errorDiv.classList.add('hidden');
            errorDiv.textContent = '';
            messageContainer.innerHTML = ''; // Clear server-rendered messages

            // 1. Get content from Quill editor and sanitize for email
            if (!quill) {
              console.error('Quill editor not found');
              errorDiv.textContent = 'Error: Email editor not loaded correctly. Try refreshing the page.';
              errorDiv.classList.remove('hidden');
              return;
            }
            const bodyHtml = sanitizeForEmail(quill.root.innerHTML);
            document.getElementById('body').value = bodyHtml;
            
            // 2. Non-blocking validation
            if(!quill.getText().trim()){
              errorDiv.textContent = 'Email body cannot be empty.';
              errorDiv.classList.remove('hidden');
              quill.focus();
              return;
            }

            // 3. Get all form data
            const apiKey = document.getElementById('api_key').value;
            const fromName = document.getElementById('from_name').value.trim();
            const fromEmail = document.getElementById('from_email').value;
            const from = fromName ? `"${fromName}" <${fromEmail}>` : fromEmail;
            const to = document.getElementById('to_email').value;
            const cc = document.getElementById('cc_email').value.trim();
            const bcc = document.getElementById('bcc_email').value.trim();
            const subject = document.getElementById('subject').value;
            const body = document.getElementById('body').value;

            if (!apiKey) {
              errorDiv.textContent = 'API Key cannot be empty.';
              errorDiv.classList.remove('hidden');
              document.getElementById('api_key').focus();
              return;
            }
            
            // 4. Update UI to show sending state
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            try {
              // 5. Construct API request
              const payload = {
                from: from,
                to: [to],
                subject: subject,
                html: body
              };
              
              // Add optional CC/BCC if provided
              if (cc) payload.cc = [cc];
              if (bcc) payload.bcc = [bcc];
              
              // Add threading headers if replying to a thread
              const inReplyTo = document.getElementById('in_reply_to').value.trim();
              const references = document.getElementById('references').value.trim();
              if (inReplyTo || references) {
                payload.headers = {};
                if (inReplyTo) payload.headers['In-Reply-To'] = inReplyTo;
                if (references) payload.headers['References'] = references;
                else if (inReplyTo) payload.headers['References'] = inReplyTo; // fallback
              }

              // 6. Send via API proxy to Resend
              const response = await fetch(`${API_URL}/api/send`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${apiKey}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
              });

              const data = await response.json();

              if (!response.ok) {
                // Handle API errors (e.g., validation, auth)
                const errorMsg = data.message || 'An unknown error occurred.';
                throw new Error(`API Error (${data.name}): ${errorMsg}`);
              }
              
              // 7. Show success message
              messageContainer.innerHTML = `
                <div class="p-4 mb-4 text-sm text-green-800 rounded-lg bg-green-50" role="alert">
                  <span class="font-medium">✓ Email Sent Successfully!</span>
                  <div class="mt-2 p-3 bg-green-100 rounded font-mono text-xs">
                    <div><strong>Email ID:</strong> ${data.id}</div>
                    <div class="mt-1"><strong>To:</strong> ${to}</div>
                    <div class="mt-1"><strong>From:</strong> ${from}</div>
                  </div>
                </div>
              `;
              
            } catch (error) {
              // Show failure message with actionable guidance
              let errorMsg = error.message;
              
              if (errorMsg.includes('401') || errorMsg.includes('Unauthorized')) {
                errorMsg += ' → Check your API key at https://resend.com/api-keys';
              } else if (errorMsg.includes('invalid_from_address') || errorMsg.includes('from')) {
                errorMsg += ' → "From" email must be verified in your Resend account';
              } else if (errorMsg.includes('invalid_to_address') || errorMsg.includes('to')) {
                errorMsg += ' → "To" email address is invalid';
              }
              
              messageContainer.innerHTML = `
                <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50" role="alert">
                  <span class="font-medium">❌ Send Failed:</span>
                  <div class="mt-1 text-xs">${errorMsg}</div>
                </div>
              `;
            } finally {
              sendBtn.disabled = false;
              sendBtn.textContent = 'Send Email';
            }
          });
        }
      });
    </script>
    
    <!-- FOOTER -->
    <div class="mt-12 pt-8 pb-4 border-t border-gray-200 text-center text-xs text-gray-500">
      <div class="mb-3">
        <a href="/landing.html" class="text-blue-600 hover:underline">About Resend Pad</a>
        ·
        <a href="/" class="text-blue-600 hover:underline">Email Editor</a>
      </div>
      Made by 
      <a href="mailto:rozetyp@gmail.com" class="text-blue-600 hover:underline">rozetyp</a>
      · 
      <a href="https://buymeacoffee.com/sandbar" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">☕ Buy Me a Coffee</a>
      · 
      <a href="https://github.com/rozetyp/resend-email" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">GitHub</a>
    </div>