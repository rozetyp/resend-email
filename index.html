<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Resend Pad - Utility</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="A minimal utility to send emails with a Resend API key." />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Pell Rich Text Editor CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pell@1.0.2/dist/pell.min.css" />
  
  <style>
    /* Custom styles for the Pell editor to match the Tailwind theme */
    .pell-content {
      outline: 0;
      min-height: 250px;
      padding: 0.75rem; /* p-3 */
      background-color: #ffffff; /* bg-white */
      color: #111827; /* text-gray-900 */
      border: 1px solid #d1d5db; /* border-gray-300 */
      border-top: 0;
      border-bottom-left-radius: 0.5rem; /* rounded-lg */
      border-bottom-right-radius: 0.5rem; /* rounded-lg */
      line-height: 1.6;
    }
    
    .pell-actionbar {
      background-color: #f9fafb; /* bg-gray-50 */
      border: 1px solid #d1d5db; /* border-gray-300 */
      border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
      border-top-left-radius: 0.5rem; /* rounded-lg */
      border-top-right-radius: 0.5rem; /* rounded-lg */
      padding: 0.25rem;
    }
    
    .pell-button {
      color: #374151; /* text-gray-700 */
      border-radius: 0.375rem; /* rounded-md */
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    
    .pell-button:hover {
      background-color: #e5e7eb; /* bg-gray-200 */
    }
    
    .pell-button-selected {
      background-color: #dbeafe; /* bg-blue-100 */
      color: #1e40af; /* text-blue-800 */
    }

    /* Basic styling for the previewed email */
    #preview_content h1 { font-size: 1.875rem; font-weight: 600; margin-bottom: 0.5rem; }
    #preview_content h2 { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; }
    #preview_content p { margin-bottom: 1rem; }
    #preview_content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
    #preview_content ol { list-style-type: decimal; margin-left: 1.5rem; margin-bottom: 1rem; }
    #preview_content a { color: #2563eb; text-decoration: underline; }
    #preview_content pre { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
  </style>
</head>

<body class="bg-gray-100">
  <!-- ============ MAIN APP CONTAINER ============ -->
  <div class="min-h-screen w-full p-4 sm:p-8 flex items-center justify-center">
    
    <div class="w-full max-w-3xl bg-white text-gray-900 rounded-xl shadow-2xl p-6 sm:p-8 mt-16">
      
      <div class="flex items-center justify-center mb-2 gap-3">
        <h1 class="text-3xl font-bold text-center text-gray-900">
          Resend Pad
        </h1>
        <a href="https://github.com/rozetyp/resend-email" target="_blank" rel="noopener noreferrer" title="View source on GitHub" class="text-gray-400 hover:text-gray-700 transition-colors">
          <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.108-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.91 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.085 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
        </a>
      </div>
      
      <p class="text-center text-sm text-gray-600 mb-6">
        Send emails with Resend using your own API key. No server relay. Built for developers.
      </p>
      
      <div class="form-container">
        <form id="send_form">
          
          <!-- API KEY INPUT -->
          <div class="mb-5">
            <label for="api_key" class="block mb-2 text-sm font-medium text-gray-900">Your Resend API Key</label>
            <input 
              type="password" 
              id="api_key" 
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
              placeholder="re_xxxxxxxxxxxxxxxxxxxxx" 
              style="font-family: 'Courier New', monospace;"
              required
            />
            <p class="mt-1 text-xs text-gray-500">Stays in your browser. Never stored.</p>
            <div class="p-3 mt-3 text-xs text-blue-800 rounded-lg bg-blue-50" role="alert">
              Tip: Need "Full Access" key to list domains. <a href="https://resend.com/api-keys" target="_blank" class="underline hover:no-underline">Get one →</a>
            </div>
          </div>

          <!-- FROM EMAIL -->
          <div class="mb-5">
            <label for="from_email" class="block mb-2 text-sm font-medium text-gray-900">From Email</label>
            <div class="flex flex-col sm:flex-row gap-2">
              <input 
                id="from_email" 
                name="from_email" 
                type="text" 
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                placeholder="no-reply@yourdomain.com" 
                required 
              />
              <button type="button" id="fetch_domains_btn" class="flex-shrink-0 text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-4 py-2.5">
                Load Domains
              </button>
            </div>
            <p class="mt-1 text-xs text-gray-500">Must be verified in your Resend account.</p>
          </div>

          <!-- TO EMAIL -->
          <div class="mb-5">
            <label for="to_email" class="block mb-2 text-sm font-medium text-gray-900">To Email</label>
            <input 
              id="to_email" 
              name="to_email" 
              type="email" 
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
              placeholder="recipient@example.com" 
              required 
            />
            <p class="mt-1 text-xs text-gray-500">Single recipient email address.</p>
          </div>

          <!-- SUBJECT -->
          <div class="mb-5">
            <label for="subject" class="block mb-2 text-sm font-medium text-gray-900">Subject</label>
            <input 
              id="subject" 
              name="subject" 
              type="text" 
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
              placeholder="Your email subject" 
              required 
            />
          </div>

          <!-- EMAIL BODY (PELL EDITOR) -->
          <div class="mb-5">
            <label for="pell" class="block mb-2 text-sm font-medium text-gray-900">Email Body</label>
            <div id="pell" class="pell"></div>
            <input type="hidden" id="body" name="body" value="" />
          </div>

          <!-- PREVIEW SECTION -->
          <div id="preview" class="hidden my-6 p-6 border border-gray-200 rounded-lg">
            <h3 class="text-xl font-semibold mb-4 text-gray-900">Email Preview</h3>
            <div id="preview_content" class="prose prose-sm max-w-none p-4 border border-gray-300 rounded-lg bg-gray-50 text-gray-900">
              <!-- Preview content injected by JS -->
            </div>
          </div>

          <!-- JS-controlled ERROR/SUCCESS ALERTS -->
          <div id="message_container">
            <!-- JS will inject success/error messages here -->
          </div>
          
          <!-- Non-blocking JS error message -->
          <div id="error-message" class="hidden p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50" role="alert"></div>

          <!-- ACTION BUTTONS -->
          <div class="flex flex-col-reverse sm:flex-row sm:justify-end sm:gap-3 mt-6">
            <button type="button" class="mt-2 sm:mt-0 w-full sm:w-auto text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-5 py-2.5" id="preview_btn">
              Preview
            </button>
            <button type="submit" id="send_btn" class="w-full sm:w-auto text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 focus:outline-none">
              Send Email
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ============ PELL EDITOR & INTERACTIONS ============ -->
  <script src="https://cdn.jsdelivr.net/npm/pell@1.0.2/dist/pell.js"></script>
  <script>
    // Auto-detect API URL based on environment
    const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3001'
      : `${window.location.protocol}//${window.location.host}`;
    
    document.addEventListener('DOMContentLoaded', function() {
        // ============ PELL EDITOR ============
        window.pell.init({
          element: document.getElementById('pell'),
          onChange: function(html) {
            document.getElementById('body').value = html;
          },
          defaultParagraphSeparator: 'p',
          actions: [
            'bold',
            'italic',
            'underline',
            'heading1',
            'heading2',
            'olist',
            'ulist',
            { name: 'link', result: () => { const url = prompt('Enter URL'); if(url) window.pell.exec('createLink', url); } },
            { name: 'code', result: () => window.pell.exec('formatBlock', '<pre>') }
          ]
        });

        // Pre-populate editor if there's saved content
        const pellContentElement = document.querySelector('#pell .pell-content');
        if(pellContentElement && document.getElementById('body').value){
          pellContentElement.innerHTML = document.getElementById('body').value;
        }

        // ============ DOMAIN FETCHING ============
        const fetchDomainsBtn = document.getElementById('fetch_domains_btn');
        const domainsList = document.getElementById('domains_list');
        const apiKeyInput = document.getElementById('api_key');
        const fromEmailInput = document.getElementById('from_email');

        fetchDomainsBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          const apiKey = apiKeyInput.value.trim();
          
          if (!apiKey) {
            domainsList.textContent = '❌ Please enter your Resend API key first.';
            domainsList.classList.remove('hidden');
            return;
          }

          fetchDomainsBtn.disabled = true;
          fetchDomainsBtn.textContent = 'Loading...';
          domainsList.classList.add('hidden');

          try {
            // Call Resend API to get domains
            const response = await fetch(`${API_URL}/api/domains`, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${apiKey}`
              }
            });

            const data = await response.json();

            if (!response.ok) {
              // Handle different error scenarios
              if (response.status === 401 || response.status === 403) {
                throw new Error(`Unauthorized: Your API key may be "Sending Only" or invalid. Use a "Full Access" key to list domains. Get one at https://resend.com/api-keys`);
              } else if (response.status === 429) {
                throw new Error(`Rate limited: Too many requests. Wait a moment and try again.`);
              } else {
                const errorMsg = data.message || data.error || `API error: ${response.status}`;
                throw new Error(errorMsg);
              }
            }

            const domains = data.data || [];
            
            if (domains.length === 0) {
              domainsList.textContent = '❌ No verified domains found. Add one in your Resend dashboard at https://resend.com/domains';
              domainsList.classList.remove('hidden');
            } else {
              // Create domain selector
              let html = '<strong>Select a verified domain:</strong><div class="mt-2 flex flex-wrap gap-2">';
              domains.forEach(domain => {
                html += `<button type="button" class="domain-btn text-xs font-medium px-2.5 py-1.5 rounded-md bg-white border border-gray-300 hover:bg-gray-100" data-domain="${domain.name}">${domain.name}</button>`;
              });
              html += '</div>';
              domainsList.innerHTML = html;
              domainsList.classList.remove('hidden');

              // Add click handlers to domain buttons
              document.querySelectorAll('.domain-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                  e.preventDefault();
                  const domain = this.dataset.domain;
                  const defaultFrom = fromEmailInput.value.split('@')[0] || 'noreply';
                  fromEmailInput.value = `${defaultFrom}@${domain}`;
                  domainsList.classList.add('hidden');
                });
              });
            }
          } catch (error) {
            domainsList.innerHTML = `<strong>❌ Failed to fetch domains:</strong><div class="mt-1 text-xs">${error.message}</div><div class="mt-2 text-xs text-gray-600">Still having issues? You can manually enter your From email (must be verified in Resend).</div>`;
            domainsList.classList.remove('hidden');
            console.error('Domain fetch error:', error);
          } finally {
            fetchDomainsBtn.disabled = false;
            fetchDomainsBtn.textContent = 'Load Domains';
          }
        });

        // ============ PREVIEW FUNCTIONALITY ============
        const preview = document.getElementById('preview');
        const previewContent = document.getElementById('preview_content');
        const previewBtn = document.getElementById('preview_btn');

        function renderPreview(){
          const subjectEl = document.getElementById('subject');
          const toEl = document.getElementById('to_email');
          const fromEl = document.getElementById('from_email');
          const subj = subjectEl ? subjectEl.value : '(no subject)';
          const to = toEl ? toEl.value : '(no to)';
          const fr = fromEl ? fromEl.value : '(no from)';
          
          let hdr = '<div class="mb-4 p-4 rounded-lg bg-gray-100 border border-gray-300">';
          hdr += '<div class="font-semibold text-lg text-gray-900">' + (subj) + '</div>';
          hdr += '<div class="text-sm text-gray-600 mt-1"><strong>From:</strong> ' + (fr) + '</div>';
          hdr += '<div class="text-sm text-gray-600"><strong>To:</strong> ' + (to) + '</div>';
          hdr += '</div>';
          
          const pellContent = document.querySelector('#pell .pell-content');
          const bodyContent = pellContent ? pellContent.innerHTML : document.getElementById('body').value;
          previewContent.innerHTML = hdr + '<div class="email-body-preview">' + (bodyContent || '<em>(empty body)</em>') + '</div>';
        }

        previewBtn && previewBtn.addEventListener('click', function(e){
          e.preventDefault();
          if(!preview) return;
          if(preview.classList.contains('hidden')){
            renderPreview();
            preview.classList.remove('hidden');
            preview.scrollIntoView({ behavior: 'smooth', block: 'center' });
            previewBtn.textContent = 'Hide Preview';
          } else {
            preview.classList.add('hidden');
            previewBtn.textContent = 'Preview';
          }
        });

        // ============ FORM SUBMISSION ============
        const form = document.getElementById('send_form');
        const errorDiv = document.getElementById('error-message');
        const messageContainer = document.getElementById('message_container');
        const sendBtn = document.getElementById('send_btn');

        if(form){
          form.addEventListener('submit', async function(e){
            e.preventDefault(); // Stop default form submission
            console.log('Form submitted');
            
            // 0. Clear previous messages
            errorDiv.classList.add('hidden');
            errorDiv.textContent = '';
            messageContainer.innerHTML = ''; // Clear server-rendered messages

            // 1. Sync Pell content to hidden body input
            const pellContent = document.querySelector('#pell .pell-content');
            if (!pellContent) {
              console.error('Pell editor content area not found');
              errorDiv.textContent = 'Error: Email editor not loaded correctly. Try refreshing the page.';
              errorDiv.classList.remove('hidden');
              return;
            }
            const bodyHtml = pellContent.innerHTML;
            document.getElementById('body').value = bodyHtml;
            
            // 2. Non-blocking validation
            if(!bodyHtml.trim()){
              errorDiv.textContent = 'Email body cannot be empty.';
              errorDiv.classList.remove('hidden');
              pellContent.focus();
              return;
            }

            // 3. Get all form data
            const apiKey = document.getElementById('api_key').value;
            const from = document.getElementById('from_email').value;
            const to = document.getElementById('to_email').value;
            const subject = document.getElementById('subject').value;
            const body = document.getElementById('body').value;

            console.log('Form data:', { apiKey: '***', from, to, subject, bodyLength: body.length });

            if (!apiKey) {
              errorDiv.textContent = 'API Key cannot be empty.';
              errorDiv.classList.remove('hidden');
              document.getElementById('api_key').focus();
              return;
            }
            
            // 4. Update UI to show sending state
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            try {
              // 5. Construct API request
              const payload = {
                from: from,
                to: [to], // Resend API expects 'to' as an array
                subject: subject,
                html: body
              };

              console.log('Sending to Resend API...');
              console.log('Payload:', payload);

              // 6. Send via API proxy to Resend
              const response = await fetch(`${API_URL}/api/send`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${apiKey}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
              });

              console.log('Response status:', response.status);

              const data = await response.json();
              console.log('Response data:', data);

              if (!response.ok) {
                // Handle API errors (e.g., validation, auth)
                const errorMsg = data.message || 'An unknown error occurred.';
                throw new Error(`API Error (${data.name}): ${errorMsg}`);
              }
              
              // 7. Show success message
              messageContainer.innerHTML = `
                <div class="p-4 mb-4 text-sm text-green-800 rounded-lg bg-green-50" role="alert">
                  <span class="font-medium">✓ Email Sent Successfully!</span>
                  <div class="mt-2 p-3 bg-green-100 rounded font-mono text-xs">
                    <div><strong>Email ID:</strong> ${data.id}</div>
                    <div class="mt-1"><strong>To:</strong> ${to}</div>
                    <div class="mt-1"><strong>From:</strong> ${from}</div>
                  </div>
                </div>
              `;
              
            } catch (error) {
              // 8. Show failure message with actionable guidance
              let errorMsg = error.message;
              
              console.error('Send error:', error);
              
              // Provide context-specific help
              if (errorMsg.includes('401') || errorMsg.includes('Unauthorized')) {
                errorMsg += ' → Check your API key at https://resend.com/api-keys';
              } else if (errorMsg.includes('invalid_from_address') || errorMsg.includes('from')) {
                errorMsg += ' → "From" email must be verified in your Resend account';
              } else if (errorMsg.includes('invalid_to_address') || errorMsg.includes('to')) {
                errorMsg += ' → "To" email address is invalid';
              } else if (errorMsg.includes('missing_required_parameters')) {
                errorMsg += ' → All fields are required (Subject, To, From, Body)';
              }
              
              messageContainer.innerHTML = `
                <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50" role="alert">
                  <span class="font-medium">❌ Send Failed:</span>
                  <div class="mt-1 text-xs">${errorMsg}</div>
                  <div class="mt-2 text-xs text-gray-600">Debug: Check the browser console (F12) for more details.</div>
                </div>
              `;
            } finally {
              // 9. Reset button state
              sendBtn.disabled = false;
              sendBtn.textContent = 'Send Email';
            }
          });
        } else {
          console.error('Form element not found');
        }
      });
    </script>
    
    <!-- FOOTER -->
    <div class="mt-12 pt-8 pb-4 border-t border-gray-200 text-center text-xs text-gray-500">
      Made by 
      <a href="mailto:rozetyp@gmail.com" class="text-blue-600 hover:underline">rozetyp</a>
      · 
      <a href="https://buymeacoffee.com/sandbar" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">☕ Buy Me a Coffee</a>
      · 
      <a href="https://github.com/rozetyp/resend-email" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">GitHub</a>
    </div>